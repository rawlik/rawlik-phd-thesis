% !TEX root = ../rawlik-phd-thesis.tex
\chapter{Next generation active magnetic field compensation}
\label{ch:sfc-prototype}

The coil design method described in the previous chapter opened the door to a next generation of active magnetic field compensation systems. Ones where the coil system is not much larger than the fiducial volume and where high-order terms of the magnetic field can be compensated, all while retaining a low number of controlled degrees of freedom.

The large fiducial volume is of particular importance for the n2EDM experiment at PSI. The available area\ldots

In the laboratory at ETH Zürich an active magnetic field compensation system was constructed, based on the coil design method described earlier. The goal was do demonstrate the feasibility of construction of the coils, develop and test the electronic and software parts of the feedback algorithm, and test the whole system.



\section{The first iteration -- coil structure}
When discussing the the coil design method we have already indicated a possible way to realise it in practice---construct a grid out of cable channels. The system, pictured in Fig.\,\ref{fig:prototype_photo}, was built as a $5 \times 9 \times 5$ square tiles. The tile size\ldots The total size\ldots
\mnote{Introduce the coordinate system somewhere here.}

\begin{figure}
  \centering
  \includegraphics[width=0.9\linewidth]{gfx/prototype/DSC03472.JPG}
  \caption{The active magnetic compensation system in the laboratory at ETH Zürich. It consists cable channels mounted on an aluminum support structure. In the channels copper wires making up the coils can be seen. On the left-hand side the control cabinet of the system is visible. Indicate the coordinate system here!}
  \label{fig:prototype_photo}
\end{figure}

The support frame was made of aluminum construction profiles. Thereon, on each side, was a large one-piece aluminum sheet, with square cut-outs leaving the material only directly below the cable channels. \note{Explain better, tricky.}

\begin{figure}
  \centering
  \includegraphics[width=0.9\linewidth]{gfx/prototype/coil_y_currents.png}
  \caption{The optimal current net for the $y$-coil of the ETH active magnetic field compensation system. Both $5 \times 5$ faces ($y = \mathrm{const}$ planes) are identical and are depicted on the left-hand side. The rectangular faces are identical, too, and are depicted on the right-hand side. For each segment the current per \SI{100}{\micro\tesla} of generated field is indicated upwards and to the right. CHECK}
  \label{fig:prototype_coil_y_currents}
\end{figure}

In its first version the system featured three coils for the homogeneous components of the magnetic field. The coils were designed following the method described in Ch.\,\ref{ch:coil_design} (excluding the simplification algorithm, as explained later). The fiducial volume was chosen to be a cuboid, centred in the system, \ldots away from the walls. The optimal current net for the $y$-coil is depicted in Fig.\,\ref{fig:prototype_coil_y_currents}. At the time when the system was constructed the simplification algorithm, as described in Ch.\,\ref{ch:coil_design} had not been developed, yet. The decomposition, shown in Fig.\,\ref{fig:prototype_coil_y_decomposition} was done arbitrarily. From the symmetry the $x$ and $z$ coils are identical. The current net are depicted in Fig.\,\ref{fig:prototype_coil_x_z_currents} and the decomposition in Fig.\,\ref{fig:prototype_coil_x_z_decomposition}.

\begin{figure}
  \centering
  \includegraphics[width=0.4\linewidth]{gfx/prototype/coil_y_decomposition.png}
  \caption{The decomposition of the current net of the $y$-coil (Fig.\,\ref{fig:prototype_coil_y_currents}) into current loops. For clarity only a sixteenth part of the system is depicted, all others being identical on the grounds of symmetry. Each loop is indicated with a different colour. The currents are given per \SI{50}{\micro\tesla} of generated field. SHOW WHICH PART IS DEPICTED ON A SMALL 3D DRAWING}
  \label{fig:prototype_coil_y_decomposition}
\end{figure}

\begin{figure}
  \centering
  \includegraphics[width=0.9\linewidth]{gfx/prototype/coil_x_z_currents.png}
  \caption{Mention, that it shows\ldots}
  \label{fig:prototype_coil_x_z_currents}
\end{figure}

% up to the point of the simplification algorithm. Here, The decomposition into loops was done by exploiting symmetries of the system. It is suboptimal in the sense, that there are more windings than there could be.

% Then describe how the coils were designed. The optimized current net is shown in Fig\,\ref{fig:prototype_coil_y_currents} (for the y-coil) and \ref{fig:prototype_coil_x_z_currents} (the x- and z-coils).

% It follows the already described coil design method, up to the point of the simplification algorithm. Here, The decomposition into loops was done by exploiting symmetries of the system. It is suboptimal in the sense, that there are more windings than there could be. The decompositions are depicted in Figs.\,\ref{fig:prototype_coil_y_decomposition} (the y-coil) and \ref{fig:prototype_coil_x_z_decomposition} (the x- and z-coils).

\begin{figure}
  \centering
  \includegraphics[width=0.9\linewidth]{gfx/prototype/coil_x_z_decomposition.png}
  \caption{Mention, that it shows\ldots}
  \label{fig:prototype_coil_x_z_decomposition}
\end{figure}

Finally, the individual loops were discretised into \SI{5}{\ampere}, \SI{1}{\ampere} and \SI{0.1}{\ampere}, all per nominal \SI{50}{\micro\tesla}. For example, the \SI{19.48}{\ampere} current, indicated in black in Fig.\,\ref{fig:prototype_coil_y_decomposition}, was realised as three windings of the \SI{5}{\ampere} wire, four of the \SI{1}{\ampere} one and five of the \SI{0.1}{\ampere} one.

An enameled was then laid in the cable channels according to the discretised design. For one current component of a coil, e.g.\ \SI{5}{\ampere} in the $x$-coil, a single, long piece of wire was laid, making up all the windings of all loops. For the three coils, each with three components, nine longs wires were laid, in total.
\marginpar{Wire thickness was\ldots}

Here would be a place for the close-up! and a close-up in \note{put a photo of a close-up, too}.


\section{Mapping}
To verify that the coils indeed produce a field of the required homogeneity they were mapped. For that purpose a robot has been built---a fluxgate on an xyz-table, controlled with stepper motors. The robot, called \emph{mapper}, is pictured in Fig.\,\ref{fig:prototype_photo_inside}.

\begin{figure}
  \centering
  \includegraphics[width=0.9\linewidth]{gfx/prototype/DSC03476.JPG}
  \caption{The inside of the active magnetic field compensation system. In the centre the mapping robot (\emph{mapper}) is visible, with a fluxgate magnetic field sensor mounted to a movable platform. Mounted on black, vertical beams there are eight fluxgates for the active feedback.}
  \label{fig:prototype_photo_inside}
\end{figure}

A beam seen in the middle of Fig.\,\ref{fig:prototype_photo_inside} could move along the $y$ direction by the means ofith two timing belts fixed to it. The belts were wound around pulleys with stepper motors, visible to the left. Along the beam, the $x$ direction, a cart was moved in the same way---a timing belt and a stepper motor. On the cart three vertical rods were attached, with a plastic (POM) platform tightly threaded around them. On the platform there was a fluxgate magnetic field sensor. In the middle of the rods there was an aluminum threaded rod, passing through a threaded hole in the platform and mounted to a stepper motor on the cart. As the motor spun the threaded rod, the platform moved vertically, along the $z$ direction.

A simple kind of map possible with the mapper is a linear one, whereby the fluxgate was moved along one direction only. A map of the $y$-coil, mapped along the $y$ direction (in the middle of $x$ and $z$), is shown on the right-hand side in Fig.\,\ref{fig:prototype_linear_map} (only the $y$-component of the magnetic field is plotted, the coil was set to produce \SI{50}{\micro\tesla}). The background field was also mapped and the plotted map has it already subtracted. The field stayed in a $\SI{\pm0.2}{\micro\tesla}$ range around the average value.

\begin{figure}
  \centering
  \includegraphics[width=0.9\linewidth]{gfx/prototype/linear_map.png}
  \caption{Right-hand side: Linear map of the homogeneous field $y$-coil. The map is along the $y$-direction, in the middle of $x$ and $z$. The $y$-component of the magnetic field is plotted. On the left-hand side additionally maps with only the \SI{5}{\ampere} component coil, and with \SI{5}{\ampere} and \SI{1}{\ampere} components coil are shown.}
  \label{fig:prototype_linear_map}
\end{figure}

On the left-hand of Fig.\,\ref{fig:prototype_linear_map} additionally the maps with only the \SI{5}{\ampere} component coil, and with \SI{5}{\ampere} and \SI{1}{\ampere} components coil are shown. It is interesting to note how much of the field is produced by each of the components. In the middle region the \SI{5}{\ampere}, \SI{1}{\ampere} and \SI{0.1}{\ampere} components produced 86\%, 11\% and 3\% of the field, respectively. At the edge the shares change to 70\%, 16\% and 14\%. \note{These numbers give also the relative requirements for the components. Five times less stable? Makes no sense\ldots What would the requirements really be? Linearity, for example! Could use worse power supplies.}

Another type of map is a planar one. A horizontal map, in the middle $xy$-plane, of the $y$-coil is presented in Fig.\,\ref{fig:prototype_plane_map}. The plot shows the maximum deviation among all three components of the magnetic field, i.e.\ in the area enclosed by the \SI{1}{\micro\tesla}~isocountour all components of the field are within \SI{1}{\micro\tesla} from the nominal field. The border of the plot corresponds to planes where the wires of the coils are. The fiducial volume is marked with grey lines. The field inside the fiducial volume stays within \SI{1}{\micro\tesla} of the nominal one of \SI{50}{\micro\tesla}, so the relative homogeneity is 2\%.
\mnote{Need to be clear about the specification---it wasn't supposed to be 2\% EVERYWHERE! Maybe bring forward the specification plot that decided on the grid size?}

\begin{figure}
  \centering
  \includegraphics[width=0.9\linewidth]{gfx/prototype/plane_map.png}
  \caption{A horizontal map, in the middle $xy$-plane, of the $y$-coil. The maximum deviation among all three components of the magnetic field is plotted, i.e.\ in the area enclosed by the \SI{1}{\micro\tesla}~isocountour all components of the field are within \SI{1}{\micro\tesla} from the nominal field. The border of the plot corresponds to planes where the wires of the coils are. The fiducial volume is marked with grey lines.}
  \label{fig:prototype_plane_map}
\end{figure}





\section{DAQ}

\begin{figure}
  \centering
  \includegraphics[width=0.6\linewidth,angle=90]{gfx/prototype/DSC03477.JPG}
  \caption{Mention, that it shows\ldots}
  \label{fig:prototype_photo_daq}
\end{figure}

The centre of the daq is software (written in julia). The software communicates with a lower-level Ethercat driver (cite the website!).

The software-hardware interface is provided by an array of EtherCAT clamps: (give numbers) ADCs and DACs.

The system works by exchanging EtherCAT packages every blabla (really put it?)

The signals of DACs are amplified (SERVOWATT) and fed to the coils.

The field is measured with eight fluxgates, visible in Fig.\,\ref{fig:prototype_photo_inside}, the analogue signals digitised with the ADCs.

Here write about the DAQ stack. Software in julia, ethercat, amplifiers, fluxgates.



\section{The SFC matrix}
Here describe the procedure of measuring the matrix, as well as the matrix itself.

Describe how the matrix is inverted to measure near the zero-field! Describe traversing the sphere and how it get smaller and smaller.

Then continue to analyse the matrix. Discuss the SVD decomposition and its singular values. Or is it the right place to do it here?


\section{The feedback algorithm}
Say, that implemented in software (julia). Write down the equation.


\section{Dynamic stabilisation}

Then show the dynamic stabilisation plot. A large permanent magnetic dipole was constructed (two neodymium magnets connected with an iron rod). It was moved

\begin{figure}
  \centering
  \subfloat{
    \label{fig:prototype_compensation_time_1}
    \includegraphics[width=.45\linewidth]{gfx/prototype/uncompensated_7_5m.png}}
  \quad
  \subfloat{
    \label{fig:prototype_compensation_time_2}
    \includegraphics[width=.45\linewidth]{gfx/prototype/compensated_7_5m.png}}
  \caption{Following the algorithm to simplify a coil. The left column shows the net of a current with the total current along edges of tiles. In each iteration the loop with the highest current is found and transferred onto the simplified solution, shown in the right column. We show iterations, from top: zeroth, fourth and eighth.}
  \label{fig:prototype_compensation_time}
\end{figure}


\begin{figure}
  \centering
  \subfloat{
    \label{fig:prototype_compensation_performance}
    \includegraphics[width=.45\linewidth]{gfx/prototype/big_magnet_performance.pdf}}
  \quad
  \subfloat{
    \label{fig:prototype_shielding_factor}
    \includegraphics[width=.45\linewidth]{gfx/prototype/big_magnet_shielding_factor.pdf}}
  \caption{Following the algorithm to simplify a coil. The left column shows the net of a current with the total current along edges of tiles. In each iteration the loop with the highest current is found and transferred onto the simplified solution, shown in the right column. We show iterations, from top: zeroth, fourth and eighth.}
  \label{fig:prototype_compensation}
\end{figure}


\section{Long-term Stability}
Write about the stability. Put the stability plot. State, that it does not require the output to be stable -- the stability is defined by the stability of the input. Say, that the level of stability reached with the system corresponds to the fluxgates' specified at 0.1K temperature drift - cannot be expected to be better than that in the laboratory.

\begin{figure}
  \centering
  \includegraphics[width=0.9\linewidth]{gfx/prototype/run7_field_stability.pdf}
  \caption{Mention, that it shows\ldots}
  \label{fig:prototype_stability}
\end{figure}



\section{Open-design cage}

